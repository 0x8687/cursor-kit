# Debug Report: Accessibility Permission Error for Window Capture

**Date**: 2025-12-05  
**Issue**: "Accessibility permission is required for window capture" error when using ScreenCaptureKit  
**Severity**: Incorrect Permission Check  
**Status**: Root Cause Identified

## Executive Summary

Window capture incorrectly requires accessibility permission when using ScreenCaptureKit. ScreenCaptureKit (macOS 12.3+) only requires screen recording permission, not accessibility permission.

**Root Cause**: Legacy permission check from CGWindowListCreateImage API still present in code.

**Impact**: Users see incorrect error message, window capture blocked unnecessarily.

**Solution**: Remove accessibility permission check for ScreenCaptureKit window capture, only check screen recording permission.

## Technical Analysis

### Problem Location

**File**: `ScreenshotApp/ViewModels/CaptureViewModel.swift`  
**Function**: `startWindowCapture()`  
**Line**: 70-78

### Problematic Code

```swift
func startWindowCapture() async {
    guard permissionManager.accessibilityStatus == .granted else {
        errorMessage = "Accessibility permission is required for window capture"  // ❌ Wrong!
        return
    }
    
    availableWindows = await captureService.listWindows()
    showingWindowSelection = true
}
```

### Root Cause

1. **Legacy API Assumption**:
   - Old `CGWindowListCreateImage` API required accessibility permission
   - Code still checks for accessibility permission
   - ScreenCaptureKit (macOS 12.3+) doesn't require it

2. **Comment vs Implementation Mismatch**:
   - `ScreenshotCaptureService.listWindows()` comment says: "ScreenCaptureKit doesn't require accessibility permission"
   - But `CaptureViewModel.startWindowCapture()` still checks for it

3. **Actual Requirements**:
   - ScreenCaptureKit only needs **screen recording permission**
   - `captureWindow()` already checks screen recording (line 60 in ScreenshotCaptureService)
   - `listWindows()` doesn't check any permissions (correctly)

### Error Flow

1. User clicks "Capture Window"
2. `startWindowCapture()` checks accessibility permission
3. If not granted → shows error message
4. Window list never loads
5. User can't proceed even though screen recording permission is granted

## Solution

Remove accessibility permission check from `startWindowCapture()`. Only check screen recording permission (which is already checked in `captureWindow()`).

### Fixed Code

```swift
func startWindowCapture() async {
    guard permissionManager.screenRecordingStatus == .granted else {
        errorMessage = "Screen recording permission is required for window capture"
        return
    }
    
    availableWindows = await captureService.listWindows()
    showingWindowSelection = true
}
```

### Additional Cleanup

1. **Fix typo in error message** (if present): "Windown" → "Window"
2. **Update Info.plist** (optional): Remove or update `NSAccessibilityUsageDescription` since it's not required
3. **Update documentation**: Remove references to accessibility permission for window capture

## Implementation

**Change**: Remove accessibility check, use screen recording check instead.

**Rationale**:
- ScreenCaptureKit doesn't require accessibility permission
- Screen recording permission is sufficient
- Already validated in `captureWindow()` method
- Matches actual API requirements

## Testing

After fix:
- [ ] Window capture works with only screen recording permission
- [ ] Window list loads correctly
- [ ] Error message is accurate
- [ ] No accessibility permission prompt appears
- [ ] Works on macOS 12.3+

## Additional Notes

- **Legacy Support**: If supporting macOS < 12.3, would need fallback that requires accessibility
- **Current Target**: macOS 12.3+ (ScreenCaptureKit), so accessibility not needed
- **Info.plist**: `NSAccessibilityUsageDescription` can remain for backward compatibility but isn't required
- **Documentation**: Update README and TESTING_NOTES to reflect correct permission requirements

---

**Report Generated By**: Debugger Agent  
**Date**: 2025-12-05

